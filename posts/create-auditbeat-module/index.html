<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="robots" content="noodp" />
        <title>How to Develop an Auditbeat Module from scrach - Zack</title><meta name="Description" content="This is my cool site"><meta property="og:title" content="How to Develop an Auditbeat Module from scrach" />
<meta property="og:description" content="Goal Our goal is to develop a simple demo project, with our own auditbeat module collecting data and populate data to ElasticSearch. You can download the source code from Github
Develop an auditbeat Module auditbeat Module send heartbeat package with host name to ElasticSearch periodically The project based on elastic-beats 8.3.3, other version should be similar.
Concept Module
A module is the component auditbeat provide the functionality. With metricbeat and libbeat, we can quickly develop an auditbeat module to collect data and popuate to ElasticSearch." />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://zackjiang21.github.io/posts/create-auditbeat-module/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-07-23T20:16:19+04:00" />
<meta property="article:modified_time" content="2022-07-23T20:16:19+04:00" /><meta property="og:site_name" content="Zack" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="How to Develop an Auditbeat Module from scrach"/>
<meta name="twitter:description" content="Goal Our goal is to develop a simple demo project, with our own auditbeat module collecting data and populate data to ElasticSearch. You can download the source code from Github
Develop an auditbeat Module auditbeat Module send heartbeat package with host name to ElasticSearch periodically The project based on elastic-beats 8.3.3, other version should be similar.
Concept Module
A module is the component auditbeat provide the functionality. With metricbeat and libbeat, we can quickly develop an auditbeat module to collect data and popuate to ElasticSearch."/>
<meta name="application-name" content="My cool site">
<meta name="apple-mobile-web-app-title" content="My cool site"><meta name="theme-color" content="#ffffff"><meta name="msapplication-TileColor" content="#da532c"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
        <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link rel="manifest" href="/site.webmanifest"><link rel="canonical" href="http://zackjiang21.github.io/posts/create-auditbeat-module/" /><link rel="stylesheet" href="/css/style.min.css"><link rel="preload" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
        <noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css"></noscript><link rel="preload" href="https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
        <noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css"></noscript><script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "headline": "How to Develop an Auditbeat Module from scrach",
        "inLanguage": "en",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "http:\/\/zackjiang21.github.io\/posts\/create-auditbeat-module\/"
        },"genre": "posts","keywords": "elastic-beats, auditbeat, metricbeat","wordcount":  825 ,
        "url": "http:\/\/zackjiang21.github.io\/posts\/create-auditbeat-module\/","datePublished": "2022-07-23T20:16:19+04:00","dateModified": "2022-07-23T20:16:19+04:00","publisher": {
            "@type": "Organization",
            "name": ""},"author": {
                "@type": "Person",
                "name": "Zack Jiang"
            },"description": ""
    }
    </script></head>
    <body data-header-desktop="fixed" data-header-mobile="auto"><script type="text/javascript">(window.localStorage && localStorage.getItem('theme') ? localStorage.getItem('theme') === 'dark' : ('auto' === 'auto' ? window.matchMedia('(prefers-color-scheme: dark)').matches : 'auto' === 'dark')) && document.body.setAttribute('theme', 'dark');</script>

        <div id="mask"></div><div class="wrapper"><header class="desktop" id="header-desktop">
    <div class="header-wrapper">
        <div class="header-title">
            <a href="/" title="Zack">Zack&#39;s Blog</a>
        </div>
        <div class="menu">
            <div class="menu-inner"><a class="menu-item" href="/posts/"> Posts </a><a class="menu-item" href="/tags/"> Tags </a><a class="menu-item" href="/categories/"> Categories </a><span class="menu-item delimiter"></span><a href="javascript:void(0);" class="menu-item theme-switch" title="Switch Theme">
                    <i class="fas fa-adjust fa-fw" aria-hidden="true"></i>
                </a><a href="javascript:void(0);" class="menu-item language" title="Select Language">
                    <i class="fa fa-globe" aria-hidden="true"></i>                      
                    <select class="language-select" id="language-select-desktop" onchange="location = this.value;"><option value="/posts/create-auditbeat-module/" selected>English</option><option value="/zh-cn/posts/create-auditbeat-module/">简体中文</option></select>
                </a></div>
        </div>
    </div>
</header><header class="mobile" id="header-mobile">
    <div class="header-container">
        <div class="header-wrapper">
            <div class="header-title">
                <a href="/" title="Zack">Zack&#39;s Blog</a>
            </div>
            <div class="menu-toggle" id="menu-toggle-mobile">
                <span></span><span></span><span></span>
            </div>
        </div>
        <div class="menu" id="menu-mobile"><a class="menu-item" href="/posts/" title="">Posts</a><a class="menu-item" href="/tags/" title="">Tags</a><a class="menu-item" href="/categories/" title="">Categories</a><a href="javascript:void(0);" class="menu-item theme-switch" title="Switch Theme">
                <i class="fas fa-adjust fa-fw" aria-hidden="true"></i>
            </a><a href="javascript:void(0);" class="menu-item" title="Select Language">
                    <i class="fa fa-globe fa-fw" aria-hidden="true"></i>
                    <select class="language-select" onchange="location = this.value;"><option value="/posts/create-auditbeat-module/" selected>English</option><option value="/zh-cn/posts/create-auditbeat-module/">简体中文</option></select>
                </a></div>
    </div>
</header><main class="main">
                <div class="container"><div class="toc" id="toc-auto">
            <h2 class="toc-title">Contents</h2>
            <div class="toc-content" id="toc-content-auto"></div>
        </div><article class="page single"><h1 class="single-title animate__animated animate__flipInX">How to Develop an Auditbeat Module from scrach</h1><div class="post-meta">
            <div class="post-meta-line"><span class="post-author"><a href="/" title="Author" rel="author" class="author"><i class="fas fa-user-circle fa-fw" aria-hidden="true"></i>Zack Jiang</a></span>&nbsp;<span class="post-category">included in <a href="/categories/elastic-beats/"><i class="far fa-folder fa-fw" aria-hidden="true"></i>Elastic Beats</a></span></div>
            <div class="post-meta-line"><i class="far fa-calendar-alt fa-fw" aria-hidden="true"></i>&nbsp;<time datetime="2022-07-23">2022-07-23</time>&nbsp;<i class="fas fa-pencil-alt fa-fw" aria-hidden="true"></i>&nbsp;825 words&nbsp;
                <i class="far fa-clock fa-fw" aria-hidden="true"></i>&nbsp;4 minutes&nbsp;</div>
        </div><div class="details toc" id="toc-static"  data-kept="">
                <div class="details-summary toc-title">
                    <span>Contents</span>
                    <span><i class="details-icon fas fa-angle-right" aria-hidden="true"></i></span>
                </div>
                <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li><a href="#goal">Goal</a></li>
    <li><a href="#concept">Concept</a></li>
    <li><a href="#develop-module">Develop Module</a></li>
    <li><a href="#develop-metricset">Develop MetricSet</a></li>
    <li><a href="#include-module-to-auditbeat">Include Module to <code>auditbeat</code></a></li>
    <li><a href="#verification">Verification</a></li>
  </ul>
</nav></div>
            </div><div class="content" id="content"><h2 id="goal">Goal</h2>
<p>Our goal is to develop a simple demo project, with our own auditbeat module collecting data and populate data to ElasticSearch. You can download the source code from <a href="https://github.com/ZackJiang21/beats/tree/module-demo" target="_blank" rel="noopener noreffer ">Github</a></p>
<ul>
<li>Develop an <code>auditbeat</code> Module</li>
<li><code>auditbeat</code> Module send heartbeat package with host name to ElasticSearch periodically</li>
</ul>
<blockquote>
<p>The project based on <code>elastic-beats</code> 8.3.3, other version should be similar.</p>
</blockquote>
<h2 id="concept">Concept</h2>
<ul>
<li>
<p>Module</p>
<p>A module is the component <code>auditbeat</code> provide the functionality. With <code>metricbeat</code> and <code>libbeat</code>, we can quickly develop an <code>auditbeat</code> module to collect data and popuate to ElasticSearch.</p>
</li>
<li>
<p>MetricSet</p>
<p>MetricSet is a basic unit in <code>auditbeat</code>, it indicates which metric to monitor in a <code>auditbeat</code> module. A module can contains more than one metircset, but some simple module only have a single metricset as well.</p>
<blockquote>
<p>In <code>auditbeat</code>, system module contains metricsets of <code>login</code>, <code>user</code>, <code>socket</code>, <code>process</code>, etc. <code>auditd</code> module only has 1 metricset.</p>
</blockquote>
</li>
<li>
<p>Fields</p>
<p>Fields is the data mapping between the data generated by <code>auditbeat</code> module and the data in ElasticSearch. <code>auditbeat</code> would convert fields to index template mappings with <code>auditbeat setup</code> command to visualize the data in Kibana.</p>
</li>
<li>
<p>Event</p>
<p>Event is the data generated by <code>auditbeat</code>, MetricSet would collect the data and convert to event, then send the data to ElasticSearch through <code>reporter</code>.</p>
</li>
</ul>
<h2 id="develop-module">Develop Module</h2>
<ol>
<li>We name our moule as <code>zack</code> and initialize the directory under <code>auditbeat/module/zack_module</code> with structure as below
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"> auditbeat/module/zack_module/
</span></span><span class="line"><span class="cl"> ├── heartbeat
</span></span><span class="line"><span class="cl"> │   ├── event.go
</span></span><span class="line"><span class="cl"> │   ├── _meta
</span></span><span class="line"><span class="cl"> │   │   └── fields.yml
</span></span><span class="line"><span class="cl"> │   └── metricset.go
</span></span><span class="line"><span class="cl"> ├── _meta
</span></span><span class="line"><span class="cl"> │   ├── data.json
</span></span><span class="line"><span class="cl"> │   └── fields.yml
</span></span><span class="line"><span class="cl"> ├── zack.go
</span></span><span class="line"><span class="cl"> └── zack_metric_set.go
</span></span></code></pre></div><blockquote>
<p><strong>Important:</strong> <code>_meta</code> has to be there, because some of <code>elastic-beats</code> dev-tools have dependencies on the <code>_meta</code> path existences.</p>
</blockquote>
</li>
<li>In <code>auditbeat/module/zack_module/zack.go</code>, clarify the module
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nx">zack_module</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> <span class="kn">import</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">     <span class="s">&#34;github.com/elastic/beats/v7/metricbeat/mb&#34;</span>
</span></span><span class="line"><span class="cl">     <span class="s">&#34;github.com/elastic/elastic-agent-libs/logp&#34;</span>
</span></span><span class="line"><span class="cl">     <span class="s">&#34;github.com/elastic/go-sysinfo&#34;</span>
</span></span><span class="line"><span class="cl"> <span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> <span class="kd">const</span> <span class="nx">moduleName</span> <span class="p">=</span> <span class="s">&#34;zack&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> <span class="kd">func</span> <span class="nf">init</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">     <span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">mb</span><span class="p">.</span><span class="nx">Registry</span><span class="p">.</span><span class="nf">AddModule</span><span class="p">(</span><span class="nx">moduleName</span><span class="p">,</span> <span class="nx">NewModule</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">         <span class="nb">panic</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">     <span class="p">}</span>
</span></span><span class="line"><span class="cl"> <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> <span class="kd">type</span> <span class="nx">ZackModule</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">     <span class="nx">mb</span><span class="p">.</span><span class="nx">BaseModule</span>
</span></span><span class="line"><span class="cl">     <span class="nx">hostName</span> <span class="kt">string</span>
</span></span><span class="line"><span class="cl"> <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> <span class="kd">func</span> <span class="nf">NewModule</span><span class="p">(</span><span class="nx">base</span> <span class="nx">mb</span><span class="p">.</span><span class="nx">BaseModule</span><span class="p">)</span> <span class="p">(</span><span class="nx">mb</span><span class="p">.</span><span class="nx">Module</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">     <span class="nx">log</span> <span class="o">:=</span> <span class="nx">logp</span><span class="p">.</span><span class="nf">NewLogger</span><span class="p">(</span><span class="nx">moduleName</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">     <span class="kd">var</span> <span class="nx">hostName</span> <span class="kt">string</span>
</span></span><span class="line"><span class="cl">     <span class="k">if</span> <span class="nx">hostInfo</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">sysinfo</span><span class="p">.</span><span class="nf">Host</span><span class="p">();</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">         <span class="nx">log</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;Could not get host info. err=%+v&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">     <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">         <span class="nx">hostName</span> <span class="p">=</span> <span class="nx">hostInfo</span><span class="p">.</span><span class="nf">Info</span><span class="p">().</span><span class="nx">Hostname</span>
</span></span><span class="line"><span class="cl">     <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">     <span class="k">if</span> <span class="nx">hostName</span> <span class="o">==</span> <span class="s">&#34;&#34;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">         <span class="nx">log</span><span class="p">.</span><span class="nf">Warnf</span><span class="p">(</span><span class="s">&#34;Could not get host name&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">     <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">     <span class="k">return</span> <span class="o">&amp;</span><span class="nx">ZackModule</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">         <span class="nx">BaseModule</span><span class="p">:</span> <span class="nx">base</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">         <span class="nx">hostName</span><span class="p">:</span>   <span class="nx">hostName</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">     <span class="p">},</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> <span class="p">}</span>
</span></span></code></pre></div><blockquote>
<ol>
<li>In <code>init</code> method, we register the module through <code>mb.Registry.AddModule</code></li>
<li>All modules should inherited from <code>mb.BaseModule</code></li>
</ol>
</blockquote>
</li>
</ol>
<h2 id="develop-metricset">Develop MetricSet</h2>
<ol>
<li>In <code>auditbeat/module/zack_module/zack_metric_set.go</code>, clarify the metricset
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nx">zack_module</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> <span class="kn">import</span> <span class="s">&#34;github.com/elastic/beats/v7/metricbeat/mb&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> <span class="kd">type</span> <span class="nx">ZackMetricSet</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">     <span class="nx">mb</span><span class="p">.</span><span class="nx">BaseMetricSet</span>
</span></span><span class="line"><span class="cl">     <span class="nx">module</span> <span class="o">*</span><span class="nx">ZackModule</span>
</span></span><span class="line"><span class="cl"> <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> <span class="kd">func</span> <span class="nf">NewZackMetricSet</span><span class="p">(</span><span class="nx">base</span> <span class="nx">mb</span><span class="p">.</span><span class="nx">BaseMetricSet</span><span class="p">)</span> <span class="nx">ZackMetricSet</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">     <span class="k">return</span> <span class="nx">ZackMetricSet</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">         <span class="nx">BaseMetricSet</span><span class="p">:</span> <span class="nx">base</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">         <span class="nx">module</span><span class="p">:</span>        <span class="nx">base</span><span class="p">.</span><span class="nf">Module</span><span class="p">().(</span><span class="o">*</span><span class="nx">ZackModule</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">     <span class="p">}</span>
</span></span><span class="line"><span class="cl"> <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> <span class="kd">func</span> <span class="p">(</span><span class="nx">ms</span> <span class="o">*</span><span class="nx">ZackMetricSet</span><span class="p">)</span> <span class="nf">Hostname</span><span class="p">()</span> <span class="kt">string</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">     <span class="k">return</span> <span class="nx">ms</span><span class="p">.</span><span class="nx">module</span><span class="p">.</span><span class="nx">hostName</span>
</span></span><span class="line"><span class="cl"> <span class="p">}</span>
</span></span></code></pre></div><blockquote>
<p>MetricSet should inherited from <code>mb.BaseMetricSet</code></p>
</blockquote>
</li>
<li>Define the event in <code>auditbeat/module/zack_module/heartbeat/event.go</code>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nx">heartbeat</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> <span class="kn">import</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">     <span class="s">&#34;github.com/elastic/beats/v7/metricbeat/mb&#34;</span>
</span></span><span class="line"><span class="cl">     <span class="s">&#34;github.com/elastic/elastic-agent-libs/mapstr&#34;</span>
</span></span><span class="line"><span class="cl"> <span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> <span class="kd">type</span> <span class="nx">HeartBeatEvent</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">     <span class="nx">HostName</span> <span class="kt">string</span>
</span></span><span class="line"><span class="cl"> <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> <span class="kd">func</span> <span class="p">(</span><span class="nx">e</span> <span class="o">*</span><span class="nx">HeartBeatEvent</span><span class="p">)</span> <span class="nf">buildHeartBeatEvent</span><span class="p">()</span> <span class="nx">mb</span><span class="p">.</span><span class="nx">Event</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">     <span class="nx">data</span> <span class="o">:=</span> <span class="nx">mapstr</span><span class="p">.</span><span class="nx">M</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">         <span class="s">&#34;host_name&#34;</span><span class="p">:</span> <span class="nx">e</span><span class="p">.</span><span class="nx">HostName</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">     <span class="p">}</span>
</span></span><span class="line"><span class="cl">     <span class="k">return</span> <span class="nx">mb</span><span class="p">.</span><span class="nx">Event</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">         <span class="nx">RootFields</span><span class="p">:</span> <span class="nx">mapstr</span><span class="p">.</span><span class="nx">M</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">             <span class="s">&#34;heartbeat&#34;</span><span class="p">:</span> <span class="nx">data</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">         <span class="p">},</span>
</span></span><span class="line"><span class="cl">     <span class="p">}</span>
</span></span><span class="line"><span class="cl"> <span class="p">}</span>
</span></span></code></pre></div></li>
<li>In <code>auditbeat/module/zack_module/heartbeat/metricset.go</code>, add the implementation of our metricset
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nx">heartbeat</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> <span class="kn">import</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">     <span class="s">&#34;github.com/elastic/beats/v7/auditbeat/module/zack_module&#34;</span>
</span></span><span class="line"><span class="cl">     <span class="s">&#34;github.com/elastic/beats/v7/metricbeat/mb&#34;</span>
</span></span><span class="line"><span class="cl">     <span class="s">&#34;github.com/elastic/beats/v7/metricbeat/mb/parse&#34;</span>
</span></span><span class="line"><span class="cl">     <span class="s">&#34;github.com/elastic/elastic-agent-libs/logp&#34;</span>
</span></span><span class="line"><span class="cl"> <span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> <span class="kd">const</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">     <span class="nx">moduleName</span>    <span class="p">=</span> <span class="s">&#34;zack&#34;</span>
</span></span><span class="line"><span class="cl">     <span class="nx">metricSetName</span> <span class="p">=</span> <span class="s">&#34;heartbeat&#34;</span>
</span></span><span class="line"><span class="cl">     <span class="nx">namespace</span>     <span class="p">=</span> <span class="s">&#34;.&#34;</span>
</span></span><span class="line"><span class="cl"> <span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> <span class="kd">type</span> <span class="nx">MetricSet</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">     <span class="nx">zack_module</span><span class="p">.</span><span class="nx">ZackMetricSet</span>
</span></span><span class="line"><span class="cl">     <span class="c1">// We can add config or other attibutes implementation here for HeartBeat MetricBeat
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>     <span class="nx">log</span> <span class="o">*</span><span class="nx">logp</span><span class="p">.</span><span class="nx">Logger</span>
</span></span><span class="line"><span class="cl"> <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> <span class="kd">func</span> <span class="nf">init</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">     <span class="nx">mb</span><span class="p">.</span><span class="nx">Registry</span><span class="p">.</span><span class="nf">MustAddMetricSet</span><span class="p">(</span><span class="nx">moduleName</span><span class="p">,</span> <span class="nx">metricSetName</span><span class="p">,</span> <span class="nx">New</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">         <span class="nx">mb</span><span class="p">.</span><span class="nf">DefaultMetricSet</span><span class="p">(),</span> <span class="nx">mb</span><span class="p">.</span><span class="nf">WithHostParser</span><span class="p">(</span><span class="nx">parse</span><span class="p">.</span><span class="nx">EmptyHostParser</span><span class="p">),</span> <span class="nx">mb</span><span class="p">.</span><span class="nf">WithNamespace</span><span class="p">(</span><span class="nx">namespace</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"> <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> <span class="kd">func</span> <span class="nf">New</span><span class="p">(</span><span class="nx">base</span> <span class="nx">mb</span><span class="p">.</span><span class="nx">BaseMetricSet</span><span class="p">)</span> <span class="p">(</span><span class="nx">mb</span><span class="p">.</span><span class="nx">MetricSet</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">     <span class="k">return</span> <span class="o">&amp;</span><span class="nx">MetricSet</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">         <span class="nx">ZackMetricSet</span><span class="p">:</span> <span class="nx">zack_module</span><span class="p">.</span><span class="nf">NewZackMetricSet</span><span class="p">(</span><span class="nx">base</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">         <span class="nx">log</span><span class="p">:</span>           <span class="nx">logp</span><span class="p">.</span><span class="nf">NewLogger</span><span class="p">(</span><span class="nx">metricSetName</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">     <span class="p">},</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"> <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> <span class="kd">func</span> <span class="p">(</span><span class="nx">ms</span> <span class="o">*</span><span class="nx">MetricSet</span><span class="p">)</span> <span class="nf">Fetch</span><span class="p">(</span><span class="nx">reporter</span> <span class="nx">mb</span><span class="p">.</span><span class="nx">ReporterV2</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">     <span class="nx">event</span> <span class="o">:=</span> <span class="nx">HeartBeatEvent</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">         <span class="nx">HostName</span><span class="p">:</span> <span class="nx">ms</span><span class="p">.</span><span class="nx">ZackMetricSet</span><span class="p">.</span><span class="nf">Hostname</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">     <span class="p">}</span>
</span></span><span class="line"><span class="cl">     <span class="nx">ms</span><span class="p">.</span><span class="nx">log</span><span class="p">.</span><span class="nf">Info</span><span class="p">(</span><span class="s">&#34;sending heartbeat event&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">     <span class="nx">reporter</span><span class="p">.</span><span class="nf">Event</span><span class="p">(</span><span class="nx">event</span><span class="p">.</span><span class="nf">buildHeartBeatEvent</span><span class="p">())</span>
</span></span><span class="line"><span class="cl"> <span class="p">}</span>
</span></span></code></pre></div><blockquote>
<p><code>Fetch</code> is used to fetch data periodically in <code>auditbeat</code>, if you want to trigger the task once, you can implement <code>Run</code> interface instead.</p>
</blockquote>
</li>
</ol>
<h2 id="include-module-to-auditbeat">Include Module to <code>auditbeat</code></h2>
<ol>
<li>
<p>With the dev-tool of <code>/dev-tools/cmd/module_include_list/module_include_list.go</code>, we can include our module into <code>auditbeat</code> ，VSCode <code>launch.json</code> example below</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">     <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;[Dev] Module Include&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">     <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;go&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">     <span class="nt">&#34;request&#34;</span><span class="p">:</span> <span class="s2">&#34;launch&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">     <span class="nt">&#34;mode&#34;</span><span class="p">:</span> <span class="s2">&#34;auto&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">     <span class="nt">&#34;cwd&#34;</span><span class="p">:</span> <span class="s2">&#34;${workspaceFolder}&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">     <span class="nt">&#34;program&#34;</span><span class="p">:</span> <span class="s2">&#34;${workspaceFolder}/dev-tools/cmd/module_include_list/module_include_list.go&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">     <span class="nt">&#34;console&#34;</span><span class="p">:</span> <span class="s2">&#34;integratedTerminal&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">     <span class="nt">&#34;args&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">         <span class="s2">&#34;-moduleDir=auditbeat/module&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">         <span class="s2">&#34;-out=auditbeat/include/list.go&#34;</span>
</span></span><span class="line"><span class="cl">     <span class="p">]</span>
</span></span><span class="line"><span class="cl"> <span class="p">}</span>
</span></span></code></pre></div><blockquote>
<p>After execution, please check <code>auditbeat/include/list.go</code> imported the module and metricset we developed
If not imported, **<em>please check the <code>meta</code> existence of module and metricset</em></p>
</blockquote>
</li>
<li>
<p>In <code>fields.yml</code>, denfine the fields mapping with <code>heartbeat.host_name</code> as <code>keyword</code></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yml" data-lang="yml"><span class="line"><span class="cl">- <span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="l">zack</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="nt">title</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;Zack&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="nt">decription</span><span class="p">:</span><span class="w"> </span><span class="p">&gt;</span><span class="sd">
</span></span></span><span class="line"><span class="cl"><span class="sd">     </span><span class="w">     </span><span class="l">These are fields generated by the insight module.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="nt">fields</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">     </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">heartbeat</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">     </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">group</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">     </span><span class="nt">fields</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">         </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">host_name</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">         </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">keyword</span><span class="w">
</span></span></span></code></pre></div></li>
<li>
<p>With dev-tool of<code>/dev-tools/cmd/asset/asset.go</code>, we generate the fields mapping in <code>auditbeat/module/zack_module/fields.go</code>, VSCode <code>launch.json</code> example below</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">     <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;[Dev] Generate Fields&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">     <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;go&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">     <span class="nt">&#34;request&#34;</span><span class="p">:</span> <span class="s2">&#34;launch&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">     <span class="nt">&#34;mode&#34;</span><span class="p">:</span> <span class="s2">&#34;auto&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">     <span class="nt">&#34;cwd&#34;</span><span class="p">:</span> <span class="s2">&#34;${workspaceFolder}&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">     <span class="nt">&#34;program&#34;</span><span class="p">:</span> <span class="s2">&#34;${workspaceFolder}/dev-tools/cmd/asset/asset.go&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">     <span class="nt">&#34;console&#34;</span><span class="p">:</span> <span class="s2">&#34;integratedTerminal&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">     <span class="nt">&#34;args&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">         <span class="s2">&#34;-in=auditbeat/module/zack_module/_meta/fields.yml&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">         <span class="s2">&#34;-out=auditbeat/module/zack_module/fields.go&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">         <span class="s2">&#34;-name=zack&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">         <span class="s2">&#34;-priority=asset.ModuleFieldsPri&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">         <span class="s2">&#34;-pkg=zack_module&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">         <span class="s2">&#34;auditbeat&#34;</span>
</span></span><span class="line"><span class="cl">     <span class="p">]</span>
</span></span><span class="line"><span class="cl"> <span class="p">}</span>
</span></span></code></pre></div></li>
<li>
<p>Update <code>auditbeat.yml</code> to enable your module and metricset in <code>auditbeat</code></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yml" data-lang="yml"><span class="line"><span class="cl"><span class="nt">auditbeat.modules</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span>- <span class="nt">module</span><span class="p">:</span><span class="w"> </span><span class="l">zack</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="nt">metricsets</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">     </span>- <span class="l">heartbeat</span><span class="w">
</span></span></span></code></pre></div></li>
</ol>
<h2 id="verification">Verification</h2>
<ol>
<li>
<p>Run <code>auditbeat setup</code> command to update index template, VSCode <code>launch.json</code> example as below</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">     <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;AuditBeat Setup&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">     <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;go&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">     <span class="nt">&#34;request&#34;</span><span class="p">:</span> <span class="s2">&#34;launch&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">     <span class="nt">&#34;mode&#34;</span><span class="p">:</span> <span class="s2">&#34;auto&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">     <span class="nt">&#34;program&#34;</span><span class="p">:</span> <span class="s2">&#34;${workspaceFolder}/auditbeat/main.go&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">     <span class="nt">&#34;cwd&#34;</span><span class="p">:</span> <span class="s2">&#34;${workspaceFolder}&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">     <span class="nt">&#34;console&#34;</span><span class="p">:</span> <span class="s2">&#34;integratedTerminal&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">     <span class="nt">&#34;asRoot&#34;</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">     <span class="nt">&#34;args&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">         <span class="s2">&#34;setup&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">         <span class="s2">&#34;-c&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">         <span class="s2">&#34;path to auditbeat.yml&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">         <span class="s2">&#34;-e&#34;</span>
</span></span><span class="line"><span class="cl">     <span class="p">]</span>
</span></span><span class="line"><span class="cl"> <span class="p">}</span>
</span></span></code></pre></div></li>
<li>
<p>Verify the index template mapping in Kibana</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="./index_template.png"
        data-srcset="./index_template.png, ./index_template.png 1.5x, ./index_template.png 2x"
        data-sizes="auto"
        alt="./index_template.png"
        title="index_template.png" /></p>
</li>
<li>
<p>Start <code>auditbeat</code>, VSCode <code>launch.json</code> example as below</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;AuditBeat&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;go&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;request&#34;</span><span class="p">:</span> <span class="s2">&#34;launch&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;mode&#34;</span><span class="p">:</span> <span class="s2">&#34;auto&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;program&#34;</span><span class="p">:</span> <span class="s2">&#34;${workspaceFolder}/auditbeat/main.go&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;console&#34;</span><span class="p">:</span> <span class="s2">&#34;integratedTerminal&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;asRoot&#34;</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;args&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;-c&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&lt;path to auditbeat.yml&gt;&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;-e&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div></li>
<li>
<p>Verify the module dumped data to ElasticSearch</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="./data.png"
        data-srcset="./data.png, ./data.png 1.5x, ./data.png 2x"
        data-sizes="auto"
        alt="./data.png"
        title="data.png" /></p>
</li>
</ol>
</div><div class="post-footer" id="post-footer">
    <div class="post-info">
        <div class="post-info-line">
            <div class="post-info-mod">
                <span>Updated on 2022-07-23</span>
            </div></div>
        <div class="post-info-line">
            <div class="post-info-md"></div>
            <div class="post-info-share">
                <span><a href="javascript:void(0);" title="Share on Twitter" data-sharer="twitter" data-url="http://zackjiang21.github.io/posts/create-auditbeat-module/" data-title="How to Develop an Auditbeat Module from scrach" data-hashtags="elastic-beats,auditbeat,metricbeat"><i class="fab fa-twitter fa-fw" aria-hidden="true"></i></a><a href="javascript:void(0);" title="Share on Facebook" data-sharer="facebook" data-url="http://zackjiang21.github.io/posts/create-auditbeat-module/" data-hashtag="elastic-beats"><i class="fab fa-facebook-square fa-fw" aria-hidden="true"></i></a><a href="javascript:void(0);" title="Share on Hacker News" data-sharer="hackernews" data-url="http://zackjiang21.github.io/posts/create-auditbeat-module/" data-title="How to Develop an Auditbeat Module from scrach"><i class="fab fa-hacker-news fa-fw" aria-hidden="true"></i></a><a href="javascript:void(0);" title="Share on Line" data-sharer="line" data-url="http://zackjiang21.github.io/posts/create-auditbeat-module/" data-title="How to Develop an Auditbeat Module from scrach"><i data-svg-src="https://cdn.jsdelivr.net/npm/simple-icons@7.3.0/icons/line.svg" aria-hidden="true"></i></a><a href="javascript:void(0);" title="Share on 微博" data-sharer="weibo" data-url="http://zackjiang21.github.io/posts/create-auditbeat-module/" data-title="How to Develop an Auditbeat Module from scrach"><i class="fab fa-weibo fa-fw" aria-hidden="true"></i></a></span>
            </div>
        </div>
    </div>

    <div class="post-info-more">
        <section class="post-tags"><i class="fas fa-tags fa-fw" aria-hidden="true"></i>&nbsp;<a href="/tags/elastic-beats/">elastic-beats</a>,&nbsp;<a href="/tags/auditbeat/">auditbeat</a>,&nbsp;<a href="/tags/metricbeat/">metricbeat</a></section>
        <section>
            <span><a href="javascript:void(0);" onclick="window.history.back();">Back</a></span>&nbsp;|&nbsp;<span><a href="/">Home</a></span>
        </section>
    </div>

    <div class="post-nav"></div>
</div>
</article></div>
            </main></div>

        <div id="fixed-buttons"><a href="#" id="back-to-top" class="fixed-button" title="Back to Top">
                <i class="fas fa-arrow-up fa-fw" aria-hidden="true"></i>
            </a><a href="#" id="view-comments" class="fixed-button" title="View Comments">
                <i class="fas fa-comment fa-fw" aria-hidden="true"></i>
            </a>
        </div><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lazysizes@5.3.2/lazysizes.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/clipboard@2.0.11/dist/clipboard.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/sharer.js@0.5.1/sharer.min.js"></script><script type="text/javascript">window.config={"code":{"copyTitle":"Copy to clipboard","maxShownLines":50},"comment":{}};</script><script type="text/javascript" src="/js/theme.min.js"></script></body>
</html>
